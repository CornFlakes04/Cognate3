<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Nexora Tech — Admin · Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link href="img/favicon.ico" rel="icon" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Libraries -->
  <link href="lib/animate/animate.min.css" rel="stylesheet" />
  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

  <!-- Your site CSS (single file) -->
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />

  <style>
    .admin-hero {
      min-height: 36vh;
    }

    .drag-area {
      border: 2px dashed #cbd5e1;
      border-radius: .75rem;
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      background: #fafafa;
      transition: .15s ease-in-out;
    }

    .drag-area.dragover {
      background: #eef6ff;
      border-color: #60a5fa;
    }

    .drag-area i {
      font-size: 1.6rem;
      display: block;
      margin-bottom: .25rem;
    }

    .thumb {
      max-width: 100%;
      height: auto;
      border-radius: .5rem;
      border: 1px solid #e5e7eb;
    }

    .search-input {
      min-width: 260px
    }

    .chip {
      display: inline-block;
      padding: .15rem .5rem;
      border-radius: 999px;
      border: 1px solid #dee2e6;
      font-size: .75rem;
      margin-right: .25rem;
    }

    .table td,
    .table th {
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <!-- Spinner -->
  <div id="spinner"
    class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <!-- Navbar -->
  <div class="container-fluid sticky-top">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
        <span class="navbar-brand d-flex align-items-center">
          <h1 class="mb-0">Nexora Tech <span class="text-primary">Admin</span></h1>
          <span class="navbar-text ms-3 d-none d-lg-inline">Dashboard</span>
        </span>

        <button class="navbar-toggler ms-auto me-0" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav ms-auto align-items-lg-center">
            <a id="logoutLink" href="#" class="btn btn-outline-danger ms-lg-3">Logout</a>
          </div>
        </div>
      </nav>
    </div>
  </div>

  <!-- Hero Start -->
  <div class="container-fluid bg-primary hero-header min-vh-50 d-flex align-items-center">
    <div class="container"></div>
  </div>
  <!-- Hero End -->

  <!-- Main -->
  <div class="container my-5">

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-products-btn" data-bs-toggle="tab" data-bs-target="#tab-products"
          type="button" role="tab" aria-controls="tab-products" aria-selected="true">
          <i class="bi bi-box-seam me-1"></i> Products
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-users-btn" data-bs-toggle="tab" data-bs-target="#tab-users" type="button"
          role="tab" aria-controls="tab-users" aria-selected="false">
          <i class="bi bi-people me-1"></i> Users
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- PRODUCTS TAB -->
      <div class="tab-pane fade show active" id="tab-products" role="tabpanel" aria-labelledby="tab-products-btn">
        <div class="row g-4">
          <!-- Form -->
          <div class="col-lg-5">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <h4 class="section-title mb-3">Add / Edit Product</h4>
                <form id="adminProductForm" class="row g-3" autocomplete="off">
                  <input type="hidden" id="adminProdId" />

                  <div class="col-md-8">
                    <label class="form-label required">Name</label>
                    <input type="text" id="adminName" class="form-control" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label required">SKU</label>
                    <input type="text" id="adminSku" class="form-control" required />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label required">Price (₱)</label>
                    <input type="number" id="adminPrice" class="form-control" min="0" step="0.01" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Date Added</label>
                    <input type="date" id="adminAdded" class="form-control" />
                  </div>

                  <div class="col-12">
                    <label class="form-label required">Categories</label>
                    <div class="d-flex flex-wrap gap-2">
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Data"
                          id="cData"><label class="form-check-label" for="cData">Data</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Bionic"
                          id="cBionic"><label class="form-check-label" for="cBionic">Bionic</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Listen"
                          id="cListen"><label class="form-check-label" for="cListen">Listen</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Vision"
                          id="cVision"><label class="form-check-label" for="cVision">Vision</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Control"
                          id="cControl"><label class="form-check-label" for="cControl">Control</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" value="Sensors"
                          id="cSensors"><label class="form-check-label" for="cSensors">Sensors</label></div>
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label required">Short Description</label>
                    <textarea id="adminDesc" class="form-control" rows="4" required
                      placeholder="What makes this product compelling…"></textarea>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Specs (optional)</label>
                    <input id="adminSpecs" class="form-control"
                      placeholder="Comma-separated (e.g., 12 DOF, 8-ch sEMG, Haptics)" />
                  </div>

                  <!-- Drag & drop image uploader -->
                  <div class="col-12">
                    <label class="form-label">Product Image</label>
                    <div id="adminDragArea" class="drag-area">
                      <i class="bi bi-cloud-arrow-up"></i>
                      <div>Drag & drop an image here, or click to select</div>
                      <small class="text-muted d-block mt-1">PNG, JPG, or GIF — max ~10MB</small>
                      <input id="adminImage" type="file" accept="image/*" class="d-none" />
                    </div>
                    <img id="adminPreview" class="thumb mt-3 d-none" alt="Preview" />
                  </div>

                  <div class="col-12 d-flex gap-2">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save</button>
                    <button type="button" id="adminBtnReset" class="btn btn-outline-secondary">Clear</button>
                  </div>
                </form>

                <div class="alert alert-info mt-3 mb-0">
                  <div class="fw-bold mb-1">Storage mode</div>
                  <small id="adminStorageMode">Checking…</small>
                </div>
                <div id="adminAlert" class="alert d-none mt-3 mb-0" role="alert"></div>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="col-lg-7">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <h4 class="section-title mb-0">Products</h4>
                  <div class="d-flex align-items-center gap-2">
                    <input id="adminQ" class="form-control form-control-sm search-input"
                      placeholder="Search name, SKU, category…" />
                    <button id="adminBtnExport" class="btn btn-outline-secondary btn-sm"><i
                        class="bi bi-download me-1"></i>Export JSON</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Price</th>
                        <th>Categories</th>
                        <th>Added</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="adminRows">
                      <tr>
                        <td colspan="7" class="text-center text-muted">Loading…</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- USERS TAB (now fully wired for your JS IDs) -->
      <div class="tab-pane fade" id="tab-users" role="tabpanel" aria-labelledby="tab-users-btn">
        <div class="row g-4">
          <!-- Users Form -->
          <div class="col-lg-5">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <h4 class="section-title mb-3">Add / Edit User</h4>
                <form id="usersForm" class="row g-3" autocomplete="off">
                  <input type="hidden" id="uId" />

                  <div class="col-12">
                    <label class="form-label required">Full name</label>
                    <input type="text" id="uFull" class="form-control" required />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label required">Username</label>
                    <input type="text" id="uUser" class="form-control" required />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label required">Email</label>
                    <input type="email" id="uEmail" class="form-control" required />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label required">Role</label>
                    <select id="uRole" class="form-select" required>
                      <option value="" selected disabled>Choose role…</option>
                      <option value="admin">Admin</option>
                      <option value="editor">Editor</option>
                      <option value="user">User</option>
                    </select>
                  </div>

                    <div class="col-md-6">
                      <label class="form-label required">Status</label>
                      <select id="uStatus" class="form-select" required>
                        <option value="">Choose…</option>
                        <option value="active">Active</option>
                        <option value="disabled">Disabled</option>
                      </select>
                    </div>

                    <div class="col-12">
                      <label class="form-label">Password <small class="text-muted">(leave blank to keep
                          current)</small></label>
                      <input type="password" id="uPass" class="form-control" />
                    </div>

                    <div class="col-12 d-flex gap-2">
                      <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save</button>
                      <button type="button" id="uBtnReset" class="btn btn-outline-secondary">Clear</button>
                    </div>
                </form>

                <div class="alert alert-info mt-3 mb-0">
                  <div class="fw-bold mb-1">Storage mode</div>
                  <small id="uStorageMode">Checking…</small>
                </div>
                <div id="uAlert" class="alert d-none mt-3 mb-0" role="alert"></div>
              </div>
            </div>
          </div>

          <!-- Users Table -->
          <div class="col-lg-7">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <h4 class="section-title mb-0">Users</h4>
                  <div class="d-flex align-items-center gap-2">
                    <input id="uQ" class="form-control form-control-sm search-input"
                      placeholder="Search name, username, email…" />
                    <button id="uBtnExport" class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-download me-1"></i>Export JSON
                    </button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Full name</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="uRows">
                      <tr>
                        <td colspan="7" class="text-center text-muted">Loading…</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- /.tab-content -->
  </div>

  <!-- Footer -->
  <div class="container-fluid bg-dark text-white-50 footer pt-5">
    <div class="container py-5">
      <div class="row g-5 text-center text-lg-start">
        <div class="col-lg-4">
          <h1 class="text-white mb-3">NEXORA</h1>
          <p class="mb-0">Internal admin — manage catalog data used by the public pages.</p>
        </div>
        <div class="col-lg-4">
          <h5 class="text-white mb-4">Get In Touch</h5>
          <p><i class="fa fa-map-marker-alt me-3"></i>123 Street, Pasig City, Philippines</p>
          <p><i class="fa fa-phone-alt me-3"></i>+63 912 345 6789</p>
          <p><i class="fa fa-envelope me-3"></i>nexora@tech.com</p>
          <div class="d-flex justify-content-center justify-content-lg-start pt-2">
            <a class="btn btn-outline-primary btn-square border-2 me-2" href="https://www.facebook.com/"><i
                class="fab fa-facebook-f"></i></a>
            <a class="btn btn-outline-primary btn-square border-2 me-2" href="https://www.instagram.com/sample"><i
                class="fab fa-instagram"></i></a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back to Top -->
  <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

  <!-- JS libs + your single JS -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/wow/wow.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>

  <script src="js/main.js"></script>
  <script src="js/auth-nav.js"></script>


  <!-- PRODUCTS logic -->
  <script>
    (function () {
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

      // ===== SMART BASE DETECTION =====
      function detectBase() {
        const m = location.pathname.match(/\/Cognate3\/?/i);
        if (m) return m[0].replace(/\/?$/, '/');
        const parts = location.pathname.split('/').filter(Boolean);
        return parts.length ? '/' + parts[0] + '/' : '/';
      }
      const base = detectBase();

      // ===== ENDPOINTS =====
      const endpoints = {
        health: base + 'api/health.php',
        upload: base + 'api/upload.php',
        list: base + 'api/products/list.php',
        create: base + 'api/products/create.php',
        update: base + 'api/products/update.php',
        remove: base + 'api/products/delete.php'
      };

      // ===== ELEMENTS =====
      const spinner = $('#spinner');
      const modeEl = $('#adminStorageMode');
      const alertEl = $('#adminAlert');
      const rowsEl = $('#adminRows');
      const qEl = $('#adminQ');
      const exportBtn = $('#adminBtnExport');

      // Form
      const f = {
        form: $('#adminProductForm'),
        id: $('#adminProdId'),
        name: $('#adminName'),
        sku: $('#adminSku'),
        price: $('#adminPrice'),
        added: $('#adminAdded'),
        desc: $('#adminDesc'),
        specs: $('#adminSpecs'),
        drag: $('#adminDragArea'),
        file: $('#adminImage'),
        preview: $('#adminPreview'),
        cData: $('#cData'), cBionic: $('#cBionic'), cListen: $('#cListen'),
        cVision: $('#cVision'), cControl: $('#cControl'), cSensors: $('#cSensors'),
        resetBtn: $('#adminBtnReset')
      };

      // ===== STATE =====
      let apiUp = false;
      let products = [];
      let pendingFile = null;
      let pendingImagePath = '';

      // ===== HELPERS =====
      function setSpinner(on) { if (!spinner) return; spinner.classList[on ? 'add' : 'remove']('show'); }
      function setMode() {
        if (modeEl) modeEl.textContent = apiUp
          ? 'Connected to backend API (SQL).'
          : 'No backend detected — using browser localStorage (demo)';
      }
      function flash(type, msg) {
        if (!alertEl) return;
        alertEl.className = 'alert alert-' + type;
        alertEl.textContent = msg;
        alertEl.classList.remove('d-none');
        setTimeout(() => alertEl.classList.add('d-none'), 2500);
      }
      const peso = v => '₱' + Number(v || 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      function getCategoriesFromForm() {
        const cats = [];
        if (f.cData.checked) cats.push('Data');
        if (f.cBionic.checked) cats.push('Bionic');
        if (f.cListen.checked) cats.push('Listen');
        if (f.cVision.checked) cats.push('Vision');
        if (f.cControl.checked) cats.push('Control');
        if (f.cSensors.checked) cats.push('Sensors');
        return cats.join(',');
      }
      function setCategoriesToForm(csv) {
        const set = new Set((csv || '').split(',').map(s => s.trim()).filter(Boolean));
        f.cData.checked = set.has('Data');
        f.cBionic.checked = set.has('Bionic');
        f.cListen.checked = set.has('Listen');
        f.cVision.checked = set.has('Vision');
        f.cControl.checked = set.has('Control');
        f.cSensors.checked = set.has('Sensors');
      }
      function escapeHtml(s) {
        return (s == null ? '' : String(s)).replace(/[&<>"']/g, c => (
          { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]
        ));
      }

      function rowHTML(p, i) {
        return `<tr data-id="${p.id}">
          <td>${i + 1}</td>
          <td>${escapeHtml(p.name || '')}</td>
          <td><code>${escapeHtml(p.sku || '')}</code></td>
          <td>${peso(p.price)}</td>
          <td>${escapeHtml(p.categories || '')}</td>
          <td>${escapeHtml((p.date_added || '').slice(0, 10))}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-1" data-act="edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" data-act="del"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      }
      function render(list) {
        const q = (qEl?.value || '').toLowerCase();
        const filtered = list.filter(p => {
          const hay = [p.name, p.sku, p.categories, p.description].map(x => (x || '').toLowerCase()).join('|');
          return hay.includes(q);
        });
        if (!rowsEl) return;
        if (!filtered.length) {
          rowsEl.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No products</td></tr>`;
          return;
        }
        rowsEl.innerHTML = filtered.map((p, i) => rowHTML(p, i)).join('');
      }

      // ===== IMAGE: drag & drop + preview =====
      function setPreviewFromFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          f.preview.src = e.target.result;
          f.preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }
      function pickFiles() { f.file.click(); }
      function acceptFileList(fileList) {
        const file = fileList && fileList[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { flash('warning', 'Please select an image file.'); return; }
        if (file.size > 10 * 1024 * 1024) { flash('warning', 'Image is too large (max 10 MB).'); return; }
        pendingFile = file;
        pendingImagePath = '';
        setPreviewFromFile(file);
      }
      if (f.drag) {
        ['dragenter', 'dragover'].forEach(evt => {
          f.drag.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); f.drag.classList.add('dragover'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
          f.drag.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); f.drag.classList.remove('dragover'); });
        });
        f.drag.addEventListener('click', pickFiles);
        f.drag.addEventListener('drop', (e) => acceptFileList(e.dataTransfer.files));
      }
      f.file?.addEventListener('change', (e) => acceptFileList(e.target.files));

      async function uploadImageIfNeeded() {
        if (!pendingFile) return pendingImagePath || '';
        if (!apiUp) {
          return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = e => resolve(String(e.target.result || ''));
            r.readAsDataURL(pendingFile);
          });
        }
        const fd = new FormData();
        fd.append('image', pendingFile);
        const r = await fetch(endpoints.upload, { method: 'POST', body: fd });
        const j = await r.json().catch(() => ({}));
        if (!r.ok || j.ok !== true || !j.path) throw new Error(j.message || 'Image upload failed');
        pendingImagePath = j.path;
        return pendingImagePath;
      }

      // ===== API DETECTION =====
      async function checkApi() {
        try {
          const r = await fetch(endpoints.health, { method: 'GET', cache: 'no-store', credentials: 'include' });
          if (r.ok) {
            try { const j = await r.json(); apiUp = j && j.ok === true ? true : true; }
            catch { apiUp = true; }
            setMode(); return;
          }
        } catch { }
        try {
          const r2 = await fetch(endpoints.list, { method: 'GET', cache: 'no-store', credentials: 'include' });
          apiUp = r2.ok || r2.status === 405;
        } catch { apiUp = false; }
        setMode();
      }

      // ===== LOAD LIST =====
      async function loadList() {
        setSpinner(true);
        try {
          if (apiUp) {
            const r = await fetch(endpoints.list, { method: 'GET', credentials: 'include', cache: 'no-store' });
            const text = await r.text();
            let j = {};
            try { j = JSON.parse(text); } catch { j = {}; }
            if (!r.ok || !j.items) throw new Error('List failed');
            products = Array.isArray(j.items) ? j.items : [];
          } else {
            const raw = localStorage.getItem('nexora_products');
            products = raw ? JSON.parse(raw) : [];
          }
          render(products);
        } catch (e) {
          products = [];
          render(products);
          flash('danger', 'Failed to load products.');
        } finally {
          setSpinner(false);
        }
      }
      function saveLocal() {
        localStorage.setItem('nexora_products', JSON.stringify(products));
      }

      // ===== CREATE/UPDATE/DELETE =====
      async function upsertProduct(payload, isEdit) {
        setSpinner(true);
        try {
          const imgPathOrDataUrl = await uploadImageIfNeeded();
          if (imgPathOrDataUrl) payload.image = imgPathOrDataUrl;

          if (apiUp) {
            const url = isEdit ? endpoints.update : endpoints.create;
            const r = await fetch(url, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok || j.ok === false) throw new Error(j.message || 'Server error');
            flash('success', isEdit ? 'Updated' : 'Created');
          } else {
            if (isEdit) {
              const idx = products.findIndex(p => String(p.id) === String(payload.id));
              if (idx >= 0) products[idx] = { ...products[idx], ...payload };
            } else {
              payload.id = Date.now();
              products.push(payload);
            }
            saveLocal();
            flash('success', isEdit ? 'Updated (demo)' : 'Created (demo)');
          }

          pendingFile = null; pendingImagePath = '';
          f.preview?.classList.add('d-none'); if (f.preview) f.preview.src = '';

          await loadList();
          f.form?.reset(); if (f.id) f.id.value = '';
          setCategoriesToForm('');
        } catch (e) {
          flash('danger', e.message || 'Save failed');
        } finally { setSpinner(false); }
      }

      async function deleteProduct(id) {
        setSpinner(true);
        try {
          if (apiUp) {
            const r = await fetch(endpoints.remove, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id })
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok || j.ok === false) throw new Error(j.message || 'Delete failed');
            flash('success', 'Deleted');
          } else {
            products = products.filter(p => String(p.id) !== String(id));
            saveLocal();
            flash('success', 'Deleted (demo)');
          }
          await loadList();
        } catch (e) {
          flash('danger', e.message || 'Delete failed');
        } finally { setSpinner(false); }
      }

      // ===== EVENTS =====
      window.addEventListener('load', () => spinner?.classList.remove('show'));

      f.form?.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const payload = {
          id: (f.id.value || '').trim() || undefined,
          name: (f.name.value || '').trim(),
          sku: (f.sku.value || '').trim(),
          price: Number(f.price.value || 0),
          date_added: (f.added.value || '').trim(),
          categories: getCategoriesFromForm(),
          description: (f.desc.value || '').trim(),
          specs: (f.specs.value || '').trim(),
          image: ''
        };
        if (!payload.name || !payload.sku || !payload.categories || isNaN(payload.price)) {
          flash('warning', 'Please fill out required fields.'); return;
        }
        upsertProduct(payload, !!payload.id);
      });

      f.resetBtn?.addEventListener('click', () => {
        f.form?.reset(); if (f.id) f.id.value = '';
        setCategoriesToForm('');
        pendingFile = null; pendingImagePath = '';
        f.preview?.classList.add('d-none'); if (f.preview) f.preview.src = '';
      });

      qEl?.addEventListener('input', () => render(products));

      exportBtn?.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(products, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'products.json';
        document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      });

      rowsEl?.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button[data-act]');
        if (!btn) return;
        const tr = ev.target.closest('tr'); if (!tr) return;
        const id = tr.getAttribute('data-id');
        const item = products.find(p => String(p.id) === String(id));
        if (!item) return;

        if (btn.dataset.act === 'edit') {
          f.id.value = item.id;
          f.name.value = item.name || '';
          f.sku.value = item.sku || '';
          f.price.value = item.price || 0;
          f.added.value = (item.date_added || '').slice(0, 10);
          f.desc.value = item.description || '';
          f.specs.value = item.specs || '';

          if (item.image) {
            f.preview.src = item.image;
            f.preview.classList.remove('d-none');
          } else {
            f.preview.classList.add('d-none'); f.preview.src = '';
          }
          pendingFile = null; pendingImagePath = '';

          setCategoriesToForm(item.categories || '');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (btn.dataset.act === 'del') {
          if (confirm('Delete this product?')) deleteProduct(id);
        }
      });

      // ===== INIT =====
      (async function init() {
        await checkApi();
        await loadList();
      })();
    })();
  </script>

  <!-- USERS logic -->
  <script>
    (function () {
      // ===== Small helpers (scoped to Users only) =====
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const escapeHtml = (s) => (s == null ? '' : String(s)).replace(/[&<>"']/g, c => (
        { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]
      ));

      function detectBase() {
        const m = location.pathname.match(/\/Cognate3\/?/i);
        if (m) return m[0].replace(/\/?$/, '/');
        const parts = location.pathname.split('/').filter(Boolean);
        return parts.length ? '/' + parts[0] + '/' : '/';
      }
      const base = detectBase();

      // ===== Endpoints (Users) =====
      const endpoints = {
        health: base + 'api/health.php',
        list: base + 'api/users/list.php',
        create: base + 'api/users/create.php',
        update: base + 'api/users/update.php',
        remove: base + 'api/users/delete.php',
      };

      // ===== Elements =====
      const storageModeEl = $('#uStorageMode');
      const alertEl = $('#uAlert');
      const rowsEl = $('#uRows');
      const qEl = $('#uQ');
      const exportBtn = $('#uBtnExport');

      const f = {
        form: $('#usersForm'),
        id: $('#uId'),
        full: $('#uFull'),
        user: $('#uUser'),
        email: $('#uEmail'),
        role: $('#uRole'),
        pass: $('#uPass'),
        status: $('#uStatus'),
        reset: $('#uBtnReset')
      };

      // ===== State =====
      let apiUp = false;
      let users = [];

      // ===== UI helpers =====
      function setMode() {
        if (!storageModeEl) return;
        storageModeEl.textContent = apiUp
          ? 'Connected to backend API (SQL).'
          : 'No backend detected — using browser localStorage (demo)';
      }
      function flash(type, msg) {
        if (!alertEl) return;
        alertEl.className = 'alert alert-' + type;
        alertEl.textContent = msg;
        alertEl.classList.remove('d-none');
        setTimeout(() => alertEl.classList.add('d-none'), 2500);
      }

      // ===== API detection =====
      async function checkApi() {
        try {
          const r = await fetch(endpoints.health, { method: 'GET', cache: 'no-store', credentials: 'include' });
          if (r.ok) {
            try { const j = await r.json(); apiUp = j && j.ok === true ? true : true; }
            catch { apiUp = true; }
            setMode(); return;
          }
        } catch { }
        try {
          const r2 = await fetch(endpoints.list, { method: 'GET', cache: 'no-store', credentials: 'include' });
          apiUp = r2.ok || r2.status === 405;
        } catch { apiUp = false; }
        setMode();
      }

      // ===== Render =====
      function rowHTML(u, i) {
        return `<tr data-id="${u.id}">
        <td>${i + 1}</td>
        <td>${escapeHtml(u.full_name || '')}</td>
        <td><code>${escapeHtml(u.username || '')}</code></td>
        <td>${escapeHtml(u.email || '')}</td>
        <td><span class="badge bg-light text-dark">${escapeHtml(u.role || '')}</span></td>
        <td>
          ${u.status === 'active'
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-secondary">Disabled</span>'}
        </td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-1" data-act="edit"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-act="del"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`;
      }

      function render(list) {
        if (!rowsEl) return;
        const q = (qEl?.value || '').toLowerCase();
        const filtered = list.filter(u => {
          const hay = [u.full_name, u.username, u.email, u.role, u.status]
            .map(x => (x || '').toLowerCase()).join('|');
          return hay.includes(q);
        });
        if (!filtered.length) {
          rowsEl.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No users</td></tr>`;
          return;
        }
        rowsEl.innerHTML = filtered.map((u, i) => rowHTML(u, i)).join('');
      }

      // ===== Load / Save =====
      async function loadList() {
        try {
          if (apiUp) {
            const r = await fetch(endpoints.list, { method: 'GET', credentials: 'include', cache: 'no-store' });
            const text = await r.text();
            let j = {};
            try { j = JSON.parse(text); } catch { j = {}; }
            if (!r.ok || !Array.isArray(j.items)) throw new Error('List failed');
            users = j.items;
          } else {
            const raw = localStorage.getItem('nexora_users');
            users = raw ? JSON.parse(raw) : [];
          }
          render(users);
        } catch (e) {
          users = [];
          render(users);
          flash('danger', 'Failed to load users.');
        }
      }
      function saveLocal() {
        localStorage.setItem('nexora_users', JSON.stringify(users));
      }

      // ===== Create / Update / Delete =====
      async function upsertUser(payload, isEdit) {
        try {
          if (apiUp) {
            const url = isEdit ? endpoints.update : endpoints.create;
            const r = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok || j.ok === false) throw new Error(j.message || 'Server error');
            flash('success', isEdit ? 'Updated' : 'Created');
          } else {
            if (isEdit) {
              const idx = users.findIndex(u => String(u.id) === String(payload.id));
              if (idx >= 0) users[idx] = { ...users[idx], ...payload };
            } else {
              payload.id = Date.now();
              users.push(payload);
            }
            saveLocal();
            flash('success', isEdit ? 'Updated (demo)' : 'Created (demo)');
          }
          await loadList();
          f.form?.reset(); if (f.id) f.id.value = '';
        } catch (e) {
          flash('danger', e.message || 'Save failed');
        }
      }

      async function deleteUser(id) {
        try {
          if (apiUp) {
            const r = await fetch(endpoints.remove, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ id })
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok || j.ok === false) throw new Error(j.message || 'Delete failed');
            flash('success', 'Deleted');
          } else {
            users = users.filter(u => String(u.id) !== String(id));
            saveLocal();
            flash('success', 'Deleted (demo)');
          }
          await loadList();
        } catch (e) {
          flash('danger', e.message || 'Delete failed');
        }
      }

      // ===== Events =====
      qEl?.addEventListener('input', () => render(users));

      exportBtn?.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(users, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'users.json';
        document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      });

      f.reset?.addEventListener('click', () => {
        f.form?.reset(); if (f.id) f.id.value = '';
      });

      f.form?.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const payload = {
          id: (f.id.value || '').trim() || undefined,
          full_name: (f.full.value || '').trim(),
          username: (f.user.value || '').trim(),
          email: (f.email.value || '').trim(),
          role: (f.role.value || '').trim(),
          status: (f.status.value || '').trim()
          // password handled below
        };
        const pass = (f.pass.value || '').trim();
        if (pass) payload.password = pass; // only send if provided

        if (!payload.full_name || !payload.username || !payload.email || !payload.role || !payload.status) {
          flash('warning', 'Please fill out required fields.'); return;
        }
        upsertUser(payload, !!payload.id);
      });

      rowsEl?.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button[data-act]');
        if (!btn) return;
        const tr = ev.target.closest('tr'); if (!tr) return;
        const id = tr.getAttribute('data-id');
        const item = users.find(u => String(u.id) === String(id));
        if (!item) return;

        if (btn.dataset.act === 'edit') {
          f.id.value = item.id;
          f.full.value = item.full_name || '';
          f.user.value = item.username || '';
          f.email.value = item.email || '';
          f.role.value = item.role || '';
          f.status.value = item.status || 'active';
          f.pass.value = ''; // never prefill password
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (btn.dataset.act === 'del') {
          if (confirm('Delete this user?')) deleteUser(id);
        }
      });

      // ===== Init =====
      (async function init() {
        await checkApi();
        await loadList();
      })();
    })();
  </script>
</body>

</html>